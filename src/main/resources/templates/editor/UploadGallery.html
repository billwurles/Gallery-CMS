<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="|Gallery Upload - ${page.title}|"></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<nav class="navbar">
    <h1 th:text="|Gallery Upload for ${page.title}|"></h1>
</nav>

<div>
    <h2 th:text="${message}"></h2>

    <!-- Drag-and-Drop Zone -->
    <div id="drag-and-drop-zone" style="border: 2px dashed #ccc; padding: 20px; text-align: center;">
        <p>Drag and drop images here</p>
        <input type="file" id="file-input" multiple style="display: none;">
        <button type="button" id="file-input-trigger">Select Files</button>
    </div>

    <!-- Preview and Metadata Form -->
    <form id="metadata-form" method="post" enctype="multipart/form-data" th:action="@{/page/{pageUrl}/gallery/upload(pageUrl=${page.url})}">
        <div id="preview-container"></div>
        <input type="hidden" name="metadata" id="metadata">
        <button type="submit">Save All</button>
    </form>
</div>

<script>
    const previewContainer = $('#preview-container');
    const metadata = [];

// Function to generate a unique ID for each image
    function generateUniqueID() {
        return 'xxx-xxx'.replace(/[x]/g, function() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            return chars.charAt(Math.floor(Math.random() * chars.length));
        });
    }

    // Trigger file input when 'Select Files' button is clicked
    $('#file-input-trigger').on('click', () => $('#file-input').click());

    // Handle file input change (when files are selected via dialog)
    $('#file-input').on('change', function () {
        const files = this.files;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const fileId = metadata.length;
const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, ''); // Get filename without extension
                previewContainer.append(`
                    <div>
                        <img src="${e.target.result}" alt="Preview" style="width: 100px;">
    <input type="text" placeholder="Title" data-id="${fileId}" class="metadata-title" value="${fileNameWithoutExt}">
                        <input type="text" placeholder="Dimensions" data-id="${fileId}" class="metadata-dimensions">
                        <label>Sold <input type="checkbox" data-id="${fileId}" class="metadata-sold"></label>
                    </div>
                `);
                metadata.push({
                    imageData: e.target.result.split(',')[1], // Save Base64-encoded image data
title: fileNameWithoutExt, // Default title is filename without extension
                    dimensions: "",
                    sold: false
                });
            };
            reader.readAsDataURL(file);
        });
    });

    // Drag over handler to prevent default behavior (browser will try to open the image)
    $('#drag-and-drop-zone').on('dragover', function (e) {
        e.preventDefault();
        $(this).css('background-color', '#f0f0f0'); // Optional: change background color when dragging over
    });

    // Drag leave handler to reset the background color
    $('#drag-and-drop-zone').on('dragleave', function () {
        $(this).css('background-color', ''); // Reset background color when drag leaves
    });

    // Handle drop event for the drag-and-drop zone
    $('#drag-and-drop-zone').on('drop', function (e) {
        e.preventDefault();  // Prevent the browser from trying to open the image
        $(this).css('background-color', ''); // Reset background color when the files are dropped

        const files = e.originalEvent.dataTransfer.files;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const fileId = metadata.length;
const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, ''); // Get filename without extension
                previewContainer.append(`
                    <div>
                        <img src="${e.target.result}" alt="Preview" style="width: 100px;">
    <input type="text" placeholder="Title" data-id="${fileId}" class="metadata-title" value="${fileNameWithoutExt}">
                        <input type="text" placeholder="Dimensions" data-id="${fileId}" class="metadata-dimensions">
                        <label>Sold <input type="checkbox" data-id="${fileId}" class="metadata-sold"></label>
                    </div>
                `);

metadata.push({
imageData: e.target.result.split(',')[1], // Save Base64-encoded image data
title: fileNameWithoutExt, // Default title is filename without extension
dimensions: "",
sold: false
});
            };
            reader.readAsDataURL(file);
        });
    });

    // Submit the form and send the data using AJAX
    $('#metadata-form').on('submit', function (e) {
        e.preventDefault();

        // Collect metadata (title, dimensions, sold)
        $('.metadata-title').each(function () {
            const id = $(this).data('id');
            metadata[id].title = $(this).val();
        });
        $('.metadata-dimensions').each(function () {
            const id = $(this).data('id');
            metadata[id].dimensions = $(this).val();
        });
        $('.metadata-sold').each(function () {
            const id = $(this).data('id');
            metadata[id].sold = $(this).is(':checked');
        });

        // Prepare the JSON payload
        const payload = {
        images: metadata.map(meta => {
        const uniqueID = generateUniqueID();
        return {
            title: meta.title,
            filename: `${meta.title.replace(/[^a-zA-Z0-9]/g, '_')}_${uniqueID}.jpg`, // Add unique ID to the filename
            dimensions: meta.dimensions,
            sold: meta.sold,
            order: "", // Add order if necessary
            imageData: meta.imageData // Base64 image data
        };
            })
        };

        // Send the JSON payload via AJAX
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function () {
                alert('Gallery and metadata saved successfully!');
                location.reload();
            },
            error: function () {
                alert('Error saving gallery.');
            }
        });
    });
</script>


</body>
</html>