<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="|Page Editor - ${name}|"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="@{/js/scripts.js}"></script>

    <!-- jQuery, UI & CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/themes/base/jquery-ui.min.css">

    <!-- summernote: include libraries(bootstrap) -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- include summernote css/js -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote.min.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize Summernote editor
        $('#richTextEditor').summernote({
            height: 300,  // Set the height of the editor
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview']],
                    ['height', ['height']]
                ]
        });

        // Populate Summernote editor with existing content
        var existingContent = document.querySelector("textarea[name='content']").value;
        if (existingContent) {
            $('#richTextEditor').summernote('code', existingContent);
        }

        // Handle form submission to include Summernote content
        document.querySelector("form").addEventListener("submit", function () {
            var contentField = document.querySelector("textarea[name='content']");
            contentField.value = $('#richTextEditor').summernote('code');
        });

        // Function to generate URL from Title
        function generateUrl() {
            var title = document.getElementById('title').value; // Get the title value
            var url = title
                .toLowerCase() // Convert to lowercase
                .replace(/[^\w\s-]/g, '') // Remove all non-word characters (except spaces and hyphens)
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-'); // Replace multiple hyphens with a single hyphen

            // Set the generated url into the URL field
            document.getElementById('url').value = url;
        }

        // Add event listener to title input field
        document.getElementById('title').addEventListener('input', generateUrl);

        // Modify form submission to map menuItem.title -> title and menuItem.url -> url
        document.querySelector("form").addEventListener("submit", function(event) {
            // Update the name attributes of title and url before submitting the form
            var titleField = document.getElementById('title');
            var urlField = document.getElementById('url');

            // Temporarily set the name attributes of the title and url fields
            titleField.setAttribute('name', 'title');
            urlField.setAttribute('name', 'url');
        });
    });
</script>
</head>
<body>
<nav
        th:replace="~{editor/fragments/navigation :: navbar(menuItems=${menuItems}, currentPage=${page.menuItem.url}, siteName=${name})}">
</nav>

<div class="content">
    <h1 th:text="|${name}|"></h1>
    <div th:if="${message}" style="color: green;">
        <p th:text="${message}"></p>
    </div>

    <!-- Gallery section -->
    <a th:href="@{/page/{url}/gallery(url=${page.menuItem.url})}">
        <h2>Edit Gallery</h2>
    </a>

    <h1>Site Content:</h1>
    <form th:action="${newPage} ? @{/page/save} : @{/page/{url}/save(url=${page.menuItem.url})}"
          th:object="${page}"
          method="post">
        <!-- Save Button -->
        <button type="submit">Save</button><br>

        <!-- Page title and URL -->
        <label for="title">Title:</label>
        <input id="title" type="text" th:field="*{menuItem.title}" placeholder="Enter the title" required />
        <br>

        <label for="url">URL:</label>
        <input id="url" type="text" th:field="*{menuItem.url}" placeholder="Enter the URL" required />
        <br>

        <label for="showInMenu">Show page in Navigation menu:</label>
        <input id="showInMenu" type="checkbox" th:field="*{showInMenu}" />
        <br>

        <label for="richTextEditor">Content:</label>
        <div id="richTextEditor">
            <textarea name="content" th:field="*{content}" style="display:none;"></textarea>
        </div>
        <br>

    </form>

    <div id="content-preview">
        <h2>Content Preview:</h2>
        <div th:if="${page.content}" th:utext="${page.content}"></div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Make the image list sortable
        $("#image-list").sortable({
            placeholder: "sortable-placeholder"
        });

        // Serialize the order of images before form submission
        $("form").on("submit", function () {
            const orderedPaintingTitles = $("#image-list li").map(function () {
                return $(this).data("id"); // Extract the title from the data-id attribute
            }).get();

            // Set the ordered painting titles as a hidden input value
            $("#orderedPaintingTitles").val(JSON.stringify(orderedPaintingTitles));
        });
    });
</script>
</body>
</html>